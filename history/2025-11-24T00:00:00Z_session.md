# TDD セッション記録 - 2024/11/24

## セッション概要
- **対象Issue**: #7 Userドメインエンティティ
- **フェーズ**: Week 2 - ユーザー登録のTDD + UI
- **成果物**: Userエンティティの基本実装（TDD Red→Green完了）

---

## 実施内容

### 1. 設計決定

#### Userエンティティの属性
```python
User:
  - id: UUID（自動生成）
  - email: EmailStr（Pydanticによる検証）
  - hashed_password: str
  - created_at: datetime（自動生成）
  - is_active: bool = True
```

#### メールバリデーション
- **採用**: Pydantic `EmailStr`
- **理由**: RFC 5321/5322準拠、FastAPIとの親和性、email-validatorライブラリがバックエンド

---

### 2. TDDサイクル

#### Red Phase
- テストファイル作成: `backend/tests/domain/test_user_registration.py`
- テストケース: 有効な属性でUserエンティティを作成できる
- 結果: `ModuleNotFoundError: No module named 'app.domain.user'`

#### Green Phase
- 実装ファイル作成: `backend/app/domain/user.py`
- 依存関係追加: `email-validator==2.1.0` を requirements.txt に追加
- 結果: テスト通過 ✓

#### Refactor Phase
- 現時点では特に大きなリファクタリングなし

---

### 3. Git操作

#### ブランチ作成
```bash
git checkout -b feature/user-entity
```

#### コミット
```
feat: Issue #7 Userドメインエンティティの基本実装

- Pydantic BaseModelを使ったUserエンティティを作成
- EmailStrによるメールバリデーション
- UUID、created_atの自動生成
- email-validatorをrequirements.txtに追加
```

#### プッシュ
```bash
git push -u origin feature/user-entity
```

---

### 4. 問題と解決

#### GitHub MCP接続エラー
- **エラー**: `MCP error -32603: Authentication Failed: Requires authentication`
- **原因**: mcp.jsonで `${GITHUB_PERSONAL_ACCESS_TOKEN}` 形式の環境変数展開がサポートされていない
- **解決**: envセクションを削除し、システム環境変数を直接使用するように変更

**変更後のmcp.json**:
```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"]
    }
  }
}
```

---

## 作成/変更ファイル

| ファイル | 操作 | 説明 |
|---------|------|------|
| `backend/app/domain/user.py` | 新規作成 | Userドメインエンティティ |
| `backend/tests/domain/test_user_registration.py` | 新規作成 | Userエンティティのテスト |
| `backend/requirements.txt` | 変更 | email-validator追加 |
| `.gitignore` | 変更 | note.md追加 |
| `.claude/mcp.json` | 変更 | env セクション削除 |

---

## 次のアクション

### 即時対応
1. Windowsシステム環境変数に `GITHUB_PERSONAL_ACCESS_TOKEN` を設定
2. Claude Code再起動
3. PRを作成

### Issue #7 残タスク
- [ ] 無効なメール形式のバリデーションテスト
- [ ] 必須フィールド検証テスト

### 今後のワークフロー
- Greenになるたびにコミット
- CIからのレビューFBを対応
- PRをマージ

---

## 学習ポイント

### Pydantic Field(default_factory=...)
- インスタンス作成時に毎回関数が呼ばれて新しい値が生成される
- UUID、datetimeの自動生成に使用

### EmailStr
- RFC準拠のメールバリデーション
- `email-validator`パッケージが必要

---

## 参考コマンド

```bash
# テスト実行
cd backend && python -m pytest tests/domain/test_user_registration.py -v

# 全テスト実行
cd backend && python -m pytest -v
```
