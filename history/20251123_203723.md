# TDD セッション記録 - 2025/11/23 20:37

## セッション概要

JWT生成・検証機能（Issue #6）をTDDで実装

---

## 実施内容

### 1. GitHub状況確認・整理

- **マージ済みPR**: #1, #2, #3（すべて`feature/password-hashing`から）
- **未プッシュコミット**: `e1fb5c1` をプッシュ
- **CI修正**: `passlib`を`requirements.txt`に追加してテスト成功

### 2. Issue #6 JWT生成・検証機能のTDD実装

#### ブランチ作成
```bash
git checkout -b feature/jwt-auth
```

#### テストケース一覧（5つ）

| # | テストケース | 結果 |
|---|-------------|------|
| 1 | トークンが文字列で返される | PASSED |
| 2 | 有効期限付きトークンにexpクレームが含まれる | PASSED |
| 3 | 有効なトークンをデコードできる | PASSED |
| 4 | 不正なトークンで例外が発生する | PASSED |
| 5 | 期限切れトークンで例外が発生する | PASSED |

#### 作成ファイル

- `backend/app/domain/jwt.py` - JWT生成・検証機能
- `backend/tests/domain/test_jwt.py` - テストケース

#### 実装した関数

```python
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    """アクセストークンを生成する"""

def verify_token(token: str) -> dict:
    """トークンを検証してペイロードを返す"""
```

### 3. 追加イシュー

- **Issue #30**: SECRET_KEY等を環境変数化（JWT設定を.envから読み込み）

---

## TDDサイクルの流れ

### テストケース1: トークン生成
1. **Red**: `from app.domain.jwt import create_access_token` → ImportError
2. **Green**: `jwt.py`作成、`create_access_token`実装
3. **Refactor**: 不要

### テストケース2: 有効期限
1. **Red**: `expires_delta`引数未対応 → TypeError
2. **Green**: `expires_delta`パラメータ追加、`exp`クレーム設定
3. **Refactor**: 不要

### テストケース3: トークン検証
1. **Red**: `verify_token`未定義 → ImportError
2. **Green**: `verify_token`関数追加
3. **Refactor**: 不要

### テストケース4-5: エラーケース
- PyJWTライブラリが自動的に例外を発生させるため追加実装不要

---

## 学習内容

### JWT（JSON Web Token）の仕組み

**例え話：暗号化されたチケット**
- 作成: 情報を秘密の鍵で暗号化
- 検証: 秘密の鍵で解読

### Pythonの辞書（dict）

```python
data = {"sub": "user@example.com"}
payload["sub"]  # → "user@example.com"
```

- キー（ラベル）と値の対応
- `sub` = Subject（誰のトークンか）
- `exp` = Expiration（有効期限）

### TDDのポイント

- テストが既に通る場合もある（ライブラリの機能確認）
- 最小限の実装でテストを通す
- リファクタリングは必要な時だけ

---

## 発生した問題と解決

### 1. passlib未インストール（CI）
- **原因**: `requirements.txt`に`passlib`が未記載
- **解決**: `passlib[bcrypt]==1.7.4`を追加

### 2. pyjwt未インストール（ローカル）
- **解決**: `pip install pyjwt`

### 3. 有効期限ロジックのバグ
- **問題**: `expires_delta`指定時に`exp`が設定されない
- **原因**: `to_encode.update`が`if`文の中にあった
- **解決**: `if`文の外に移動

---

## 次のステップ

1. 変更をコミット・プッシュ
2. PRを作成
3. Week 2のイシュー（ユーザー登録）に進む

---

## コミット情報

```
feat: Issue #6 JWT生成・検証機能をTDDで実装

- create_access_token: トークン生成（有効期限対応）
- verify_token: トークン検証
- 5つのテストケースを作成
- Issue #30 SECRET_KEY環境変数化をイシューに追加
```
